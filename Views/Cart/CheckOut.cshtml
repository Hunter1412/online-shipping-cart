@model OnlineShoppingCart.Models.DTOs.OrderDto
@using Microsoft.AspNetCore.Identity
@using OnlineShoppingCart.Data.Entities

@inject SignInManager<AppUser> SignInManager
@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json
@using OnlineShoppingCart.Models;

@inject OnlineShoppingCart.Utils.CartService CartService;

@{
    var carts = CartService.GetCartItems();
    var voucher = CartService.GetVoucher();
    var code = voucher != null ? voucher.Code : string.Empty;
    double discount = voucher != null ? voucher.Discount : 0.00;

}


<section class="container checkout-container">
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <ol class="breadcrumb float-sm-end">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index"
                            class="text-decoration-none">Home</a></li>
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Shop"
                            class="text-decoration-none">Shopping-Cart</a></li>
                    <li class="breadcrumb-item"><a asp-controller="Cart" asp-action="Cart"
                            class="text-decoration-none">Shopping-Cart</a></li>
                    <li class="breadcrumb-item"><a asp-controller="Cart" asp-action="CheckOut"
                            class="text-decoration-none">Check-out</a></li>

                </ol>
            </div><!-- /.row -->
        </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->
    <!-- Main content -->
    <div class="row py-5">
        <h1 class="card-header text-center">Order Information</h1>
        <form asp-controller="" asp-action="" method="post">
        <div class="card-body row">
            <!-- Order Start -->
            <div class="col-md-7">
                    <div class="card mb-3">
                        <h4 class="card-header">Contact</h4>
                        <div class="card-body">
                            @if (!SignInManager.IsSignedIn(User))
                            {
                                <small id="" class="float-end">Have an account?
                                <a class="text-dark" id="login" asp-area="Identity" asp-page="/Account/Login">Log in</a>
                                </small>
                            }

                            <div class="form-group">
                                <input type="email" asp-for="Shipping.Email" class="form-control"
                                    placeholder="Enter your email">

                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <h4 class="card-header">Delivery to</h4>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input asp-for="Shipping.Name" class="form-control" placeholder="Full name">
                                </div>
                                <div class="col-md-6"><input asp-for="Shipping.Phone" type="phone" class="form-control" placeholder="Phone"></div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <input asp-for="Shipping.City" class="form-control" placeholder="City">
                                </div>
                                <div class="col-md-4">
                                    <input asp-for="Shipping.Province" class="form-control" placeholder="District">
                                </div>
                                <div class="col-md-4">
                                    <input asp-for="Shipping.Wards" class="form-control" placeholder="Wards">
                                    </div>
                            </div>
                            <div class="col-12  mb-3">
                                <input asp-for="Shipping.Address" class="form-control" placeholder="Address">
                            </div>
                            <div class="form-group mb-3">
                                <label for="">Shiping method</label>
                                <select class="form-control form-control" name="" id="">
                                    <option>A</option>
                                    <option>B</option>
                                    <option>C</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <h4 class="card-header">Payment</h4>
                        <div class="card-body">
                            <small class="text-muted">All transactions are secure and encrypted.</small>
                            <label class="custom-control custom-radio my-3">
                                <input type="radio" asp-for="PaymentMethod" value="1"
                                    class="custom-control-input">
                                <b class="custom-control-indicator">Pay using online payment methods</b>
                                <p class="custom-control-description text-sm text-muted">
                                    After clicking “Pay now”, you will be redirected to Pay using online payment methods to
                                    complete your purchase securely.
                                    <a href="/Home/PaymentWithPayPal" class="btn btn-primary">PayPal</a>
                                </p>
                            </label>
                            <label class="custom-control custom-radio">
                                <input type="radio" asp-for="PaymentMethod" value="2"
                                    class="custom-control-input">
                                <b class="custom-control-indicator">Pay cash at the time of delivery</b>
                                <p class="custom-control-description text-sm text-muted">Only for customer VPP</p>
                            </label>
                        </div>
                    </div>
                    <input asp-for="Voucher.Code">
                    <div class="form-group mb-3">
                        @{
                            var isDisabled = string.Empty;
                            @if (!SignInManager.IsSignedIn(User))
                            {
                                isDisabled = "disabled";
                            }
                            <button type="submit" class="btn btn-lg btn-success w-100" @isDisabled >Pay now</button>
                        }
                    </div>
            </div>


            <!-- Shopping Start -->
            <div class="col-md-5 float-end">
                <div class="card sidebar-sticky">
                    <h4 class="card-header">Your Shopping-Cart</h4>
                    @if (carts?.Count > 0)
                    {
                        double total = 0;
                        <div class="card-body">
                            @foreach (var item in carts)
                            {
                                double newPrice = (double)(item.Product!.Price! - item.Product?.Promotion!);
                                double amount = item.Quantity * newPrice;
                                total += amount;
                                <!-- CartItem Start -->
                                <div class="mt-3">
                                    <div class="d-flex justify-content-around align-items-center">
                                        <span class="col-3 position-relative">
                                            <img src="~/assets/img/@(item.ImageName)" alt="cartItem" class="rounded w-100 h-100"
                                                style="width: 100%;height:100%;">
                                            <span
                                                class="position-absolute top-0 left-100 translate-middle badge rounded-pill bg-secondary text-light"
                                                style="font-size: 1.2rem;">
                                                @(item.Quantity)
                                            </span>
                                        </span>
                                        <span class="col-7 px-3 text-sm">
                                            <a asp-controller="Home" asp-action="ShopSingle"
                                                class="cart-name-product text-decoration-none">
                                                @item.Product!.Name- @item.Product!.Id
                                            </a>
                                        </span>
                                        <span class="text-end text-sm">
                                            $ @amount.ToString("N2")
                                        </span>
                                    </div>
                                </div>
                                <div class="dropdown-divider"></div>
                                <!-- CartItem End -->
                            }
                        </div>

                        <div class="card-footer">
                            <div class="row mt-3">
                                <strong class="col-sm-6">Subtotal:</strong>
                                <strong class="col-sm-6 text-end">$ <span id="subtotal">@total.ToString("N2")</span></strong>
                            </div>
                            <div class="row mt-3 align-items-center d-inline-block">
                                <div id="form_voucher" class="row col-12">
                                    <span class="col-3"><label for="voucher">Voucher:</label></span>
                                    <span class="col-4">
                                        <input class="form-control-sm form-control" type="text" id="code" name="code" value="@code"
                                            placeholder="Enter code" required >
                                    </span>
                                    <span class="col-1">
                                        <button id="check_voucher" class="btn btn-outline-success btn-md">Check</button>
                                        <span is="error_voucher"></span>
                                    </span>
                                    <span class="col-4 text-end">$ <span id="discount">@discount.ToString("N2")</span></span>
                                </div>
                            </div>
                            <div class="row mt-3 align-items-center">
                                <div class="col-8">Shiping fee</div>
                                <div class="col-4 text-end" id="shppingFee">$ 0.00</div>
                            </div>
                            <div class="row mt-3 text-end">
                                <strong class="col-sm-6">Total:</strong>
                                <strong class="col-sm-6 border-bottom" >$<span id="total">
                                    @((total - discount).ToString("N2"))
                                </span></strong>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
        </form>
    </div>
</section>


@section Scripts {
    <script>
        @{
            await Html.RenderPartialAsync("_ValidationScriptsPartial");
        }

        $(document).ready(function () {


            @* async function getProvinces(){
                const url = 'https://provinces.open-api.vn/api/?depth=3';
                return (await fetch(url)).json();
            }; *@

                @* const provinces = await ()=>{
                let data = await getProvinces();
                return JSON.stringify(data);

                }
                console.log(provinces()); *@



        });
    </script>

}
